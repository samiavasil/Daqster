#!/usr/bin/env bash
# Render staged .puml diagrams before commit and stage generated SVG/PNG.
set -e

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT" || exit 1

# Find staged puml files
staged=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^Docs/diagrams/.*\.puml$' || true)
if [ -z "$staged" ]; then
  exit 0
fi

# If any .puml is staged, render ALL diagrams for consistency
all_puml=$(ls Docs/diagrams/*.puml 2>/dev/null || true)
if [ -n "$all_puml" ]; then
  render_list="$all_puml"
else
  render_list="$staged"
fi

# Locate plantuml: CLI, local jar, or docker
FOUND_PLANTUML=0
if command -v plantuml >/dev/null 2>&1; then
  PLANTUML_CMD="plantuml"
  FOUND_PLANTUML=1
elif [ -f "./tools/plantuml.jar" ]; then
  PLANTUML_CMD="java -jar ./tools/plantuml.jar"
  FOUND_PLANTUML=1
elif [ -f "./plantuml.jar" ]; then
  PLANTUML_CMD="java -jar ./plantuml.jar"
  FOUND_PLANTUML=1
elif command -v docker >/dev/null 2>&1; then
  PLANTUML_CMD="docker run --rm -v \"$PWD\":/workspace -w /workspace plantuml/plantuml:jetty"
  FOUND_PLANTUML=1
fi

if [ "$FOUND_PLANTUML" -ne 1 ]; then
  echo
  echo "⚠️  PlantUML not found. Diagrams will NOT be rendered."
  echo "   Options:"
  echo "     - Install PlantUML (plantuml CLI) or place plantuml.jar in project root or ./tools/"
  echo "     - Use Docker: install Docker and rendering will use the container"
  echo
  echo "To skip hook and commit anyway, run:"
  echo "  git commit --no-verify"
  echo
  # Determine strict mode: environment variable or git config 'hooks.plantumlStrict'
  STRICT_ENV="${PLANTUML_HOOK_STRICT:-}" 
  if [ -z "$STRICT_ENV" ]; then
    # check git config (local)
    STRICT_CFG=$(git config --local --get hooks.plantumlStrict || echo "")
    if [ "$STRICT_CFG" = "true" ] || [ "$STRICT_CFG" = "1" ]; then
      STRICT_ENV=1
    fi
  fi

  if [ "$STRICT_ENV" = "1" ]; then
    echo "Hook is in strict mode (PLANTUML_HOOK_STRICT=1 or git config hooks.plantumlStrict=true). Aborting commit."
    exit 1
  else
    echo "Proceeding without rendering (friendly mode)."
    exit 0
  fi
fi

echo "Rendering PlantUML diagrams..."

# Determine output formats from git config, default to svg only
formats_cfg=$(git config --local --get hooks.plantumlFormats || echo "svg")
formats=""
for fmt in $formats_cfg; do
  case "$fmt" in
    svg) formats="$formats -tsvg" ;;
    png) formats="$formats -tpng" ;;
    *) echo "Unknown format in hooks.plantumlFormats: $fmt (supported: svg png)" ;;
  esac
done
formats=$(echo "$formats" | xargs) # trim
if [ -z "$formats" ]; then
  formats="-tsvg"
fi

for f in $render_list; do
  echo "  rendering $f"
  # Render outputs in the same directory as the .puml file
  if [[ "$PLANTUML_CMD" == docker* ]]; then
    for opt in $formats; do
      $PLANTUML_CMD $opt "$f"
    done
  else
    for opt in $formats; do
      $PLANTUML_CMD $opt "$f"
    done
  fi
done

# Stage generated files according to formats
if echo "$formats_cfg" | grep -qw svg; then
  git add Docs/diagrams/*.svg || true
fi
if echo "$formats_cfg" | grep -qw png; then
  git add Docs/diagrams/*.png || true
fi
exit 0
