name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
      
      - name: Ensure submodules full history
        run: |
          git submodule sync --recursive
          git submodule update --init --recursive --depth=0
      
      - name: Install Qt from system packages
        run: |
          sudo apt-get update
          sudo apt-get install -y qt5-default qtbase5-dev qtcharts5-dev qtquickcontrols2-5-dev qtmultimedia5-dev libssl-dev
      
      - name: Debug Qt installation
        run: |
          echo "Qt installation debug info:"
          echo "PATH: $PATH"
          which qmake || echo "qmake not found"
          which qtpaths || echo "qtpaths not found"
          
          # Провери Qt версията
          qmake --version || echo "qmake version not available"
          
          # Провери Qt пътищата
          qmake -query QT_INSTALL_PREFIX || echo "QT_INSTALL_PREFIX not available"
          qmake -query QT_INSTALL_LIBS || echo "QT_INSTALL_LIBS not available"
          qmake -query QT_INSTALL_QML || echo "QT_INSTALL_QML not available"
          qmake -query QT_INSTALL_PLUGINS || echo "QT_INSTALL_PLUGINS not available"
          
          # Провери наличните Qt модули
          echo "Checking Qt modules:"
          ls -la /usr/lib/x86_64-linux-gnu/qt5/qml/ || echo "QML modules not found"
          ls -la /usr/lib/x86_64-linux-gnu/qt5/plugins/ || echo "Qt plugins not found"
      
      - name: Configure
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
      
      - name: Build
        run: |
          cmake --build build -j
      
      - name: Install to staging
        run: |
          cmake --install build --prefix "$PWD/stage"
      
      - name: Create AppImage structure
        run: |
          mkdir -p Daqster.AppDir/{usr/{bin,lib,share},usr/share/applications,usr/share/icons/hicolor/256x256/apps}
          
          # Копирай изпълнимия файл
          cp stage/bin/Daqster Daqster.AppDir/usr/bin/
          
          # Копирай библиотеките
          cp -r stage/lib/* Daqster.AppDir/usr/lib/
          
          # Копирай Qt библиотеки и модули от системните пакети
          cp -r /usr/lib/x86_64-linux-gnu/qt5/* Daqster.AppDir/usr/lib/
          
          # Копирай икона (ако има)
          if [ -f "src/apps/Daqster/icons/Daqster.png" ]; then
            cp src/apps/Daqster/icons/Daqster.png Daqster.AppDir/usr/share/icons/hicolor/256x256/apps/daqster.png
          else
            # Създай проста икона
            convert -size 256x256 xc:blue -fill white -draw "text 50,150 'D'" Daqster.AppDir/usr/share/icons/hicolor/256x256/apps/daqster.png
          fi
          
          # Създай .desktop файл
          cat > Daqster.AppDir/usr/share/applications/daqster.desktop << 'EOF'
          [Desktop Entry]
          Name=Daqster
          Comment=Professional development platform with plugin architecture
          Exec=daqster
          Icon=daqster
          Terminal=false
          Type=Application
          Categories=Development;IDE;
          Keywords=development;plugin;framework;
          EOF
          
          # Създай AppRun скрипт
          cat > Daqster.AppDir/AppRun << 'EOF'
          #!/bin/bash
          HERE="$(dirname "$(readlink -f "${0}")")"
          
          # Задай пътища за библиотеките
          export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"
          
          # Задай пътища за Qt
          export QML2_IMPORT_PATH="${HERE}/usr/lib/qml:${QML2_IMPORT_PATH}"
          export QT_PLUGIN_PATH="${HERE}/usr/lib/plugins:${QT_PLUGIN_PATH}"
          export QT_QPA_PLATFORM_PLUGIN_PATH="${HERE}/usr/lib/plugins/platforms"
          
          # Задай път за плъгините
          export DAQSTER_PLUGIN_DIR="${HERE}/usr/lib/daqster/plugins"
          
          # Стартирай приложението
          exec "${HERE}/usr/bin/Daqster" "$@"
          EOF
          
          chmod +x Daqster.AppDir/AppRun
          
          # Покажи структурата
          echo "AppImage structure created:"
          find Daqster.AppDir -type f
      
      - name: Create AppImage
        run: |
          # Инсталирай appimagetool
          wget -c "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage"
          chmod +x appimagetool-x86_64.AppImage
          
          # Създай AppImage
          ./appimagetool-x86_64.AppImage Daqster.AppDir Daqster-x86_64.AppImage
          
          # Провери AppImage
          file Daqster-x86_64.AppImage
          ls -la Daqster-x86_64.AppImage
      
      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: Daqster-AppImage
          path: Daqster-x86_64.AppImage
